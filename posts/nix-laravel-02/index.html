<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=icon type=image/ico href=https://sirimhrzn.github.io//favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://sirimhrzn.github.io//favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sirimhrzn.github.io//favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://sirimhrzn.github.io//android-chrome-192x192.png><link rel=apple-touch-icon sizes=180x180 href=https://sirimhrzn.github.io//apple-touch-icon.png><meta name=description content><title>Part 1: Using Nix to package Laravel/Lumen | Siri
</title><link rel=canonical href=https://sirimhrzn.github.io/posts/nix-laravel-02/><meta property="og:url" content="https://sirimhrzn.github.io/posts/nix-laravel-02/"><meta property="og:site_name" content="Siri"><meta property="og:title" content="Part 1: Using Nix to package Laravel/Lumen"><meta property="og:description" content="note: this is a work in progress, I aim to publish this entire series by the end of november
The project I will be packaging is a fairly old project running Laravel/Lumen 5.7 with php73 and we will also be using flakes. We have three options for packaging Laravel applications :
Write derivation from scratch using stdenv.mkDerivation Use pkgs.php.buildComposerProject builder from nixpkgs Use composer2nix to generate nix expressions for composer packages While writing your own derivation is generally good if you want to have more control over the different phases of builds & installs, but you might have to do some extra work to manage output hashes for your dependencies i."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-01T19:47:24+05:45"><meta property="article:modified_time" content="2024-11-01T19:47:24+05:45"><link rel=stylesheet href=/assets/combined.min.14e1218b5e9a0404dee05846c1ffd60757d618f79d3897fdd4eea5f441a9a7af.css media=all></head><body class=auto><div class=content><header><div class=header><h1 class=header-title><a href=https://sirimhrzn.github.io/>Siri</a></h1><div class=flex><p class=small><a href=/>/home</a></p><p class=small><a href=/posts>/posts</a></p></div></div></header><main class=main><div><div class=single-intro-container><h1 class=single-title>Part 1: Using Nix to package Laravel/Lumen</h1><p class=single-readtime><time datetime=2024-11-01T19:47:24+05:45>November 1, 2024</time></p></div><div class=single-content><blockquote><p>note: this is a work in progress, I aim to publish this entire series by the end of november</p></blockquote><p>The project I will be packaging is a fairly old project running Laravel/Lumen 5.7 with php73 and we will also be using flakes. We have three options for packaging Laravel applications :</p><ul><li>Write derivation from scratch using <a href=https://nixos.org/manual/nixpkgs/stable/#chap-stdenv><code>stdenv.mkDerivation</code></a></li><li>Use <a href=https://github.com/NixOS/nixpkgs/blob/release-24.05/pkgs/build-support/php/builders/default.nix><code>pkgs.php.buildComposerProject</code></a> builder from <a href=https://github.com/NixOS/nixpkgs/>nixpkgs</a></li><li>Use <a href=https://github.com/svanderburg/composer2nix>composer2nix</a> to generate nix expressions for composer packages</li></ul><p>While writing your own derivation is generally good if you want to have more control over the different phases of builds & installs, but you might have to do some extra work to manage output hashes for your dependencies i.e composer packages in our case. <a href=https://github.com/svanderburg/composer2nix>Composer2nix</a> works pretty well too but I had to fork and patch the project for it to work with php73, I did get it working but it was not the best solution so we will be using <a href=https://github.com/NixOS/nixpkgs/blob/release-24.05/pkgs/build-support/php/builders/default.nix><code>pkgs.php.buildComposerProject</code></a>.</p><p>However <code>pkgs.php.buildComposerProject</code> does not exist for php73, so we need to extract this expression from newer release and those attributes to our php73 package.</p><p>To get things working with php73, we need the <code>buildComposerProject</code> attribute in our php package which we can do by overriding attributes and passing them with passthru.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>phpWithComposerDrv <span>=</span>
</span></span><span style=display:flex><span>    (old-pkgs.php73.buildEnv {
</span></span><span style=display:flex><span>        extensions = ({ enabled, all }: enabled ++ (<span style=font-weight:700;text-decoration:underline>with</span> all; [ ]));
</span></span><span style=display:flex><span>    }).overrideAttrs
</span></span><span style=display:flex><span>        (prev: {
</span></span><span style=display:flex><span>            passthru = prev.passthru // {
</span></span><span style=display:flex><span>              <span style=font-weight:700;text-decoration:underline>inherit</span> (pkgs.php)
</span></span><span style=display:flex><span>                composerHooks
</span></span><span style=display:flex><span>                buildComposerProject
</span></span><span style=display:flex><span>                mkComposerRepository
</span></span><span style=display:flex><span>                buildComposerWithPlugin
</span></span><span style=display:flex><span>                ;
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>        });
</span></span></code></pre></div><p>In the expression above, old-pkgs contains <a href="https://github.com/nixos/nixpkgs?ref=release-20.09">release-20.09</a> and pkgs contains <a href="https://github.com/nixos/nixpkgs?ref=release-24.05">release-24.05</a>. We get our php73 package and then we pass attribute <code>buildComposerProject</code> from newer nixpkgs release.</p><p>So are we done here ? Well, I thought I was as now I had access to the <code>buildComposerProject</code> attribute but that wasn&rsquo;t the case. See the problem was <code>buildComposerProject</code> was running composer with a plugin <a href=https://github.com/nix-community/composer-local-repo-plugin>composer-local-repo-plugin</a> which allows composer to run in &ldquo;<a href=https://github.com/nix-community/composer-local-repo-plugin/blob/main/README.md#L3>offline</a>&rdquo; mode. However, this plugin requires Composer 2, which is not available in <a href="https://github.com/nixos/nixpkgs?ref=release-20.09">release-20.09</a>. You might be thinking we can just composer 2 from newer release but again that doesn&rsquo;t work because newer composer is built using >=php80. So then what do we do now?,we have to build composer according to our requirements which is basically telling it to use php73 which relatively easy as according to composer documentation the latest version of composer works with >=php72 so all we need to do rebuild composer by overriding the <code>buildInputs</code> and passing the php package we want it to use.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>    composerLatest <span>=</span> pkgs.php.packages.composer.overrideAttrs (
</span></span><span style=display:flex><span>        finalAttrs: previousAttrs: {
</span></span><span style=display:flex><span>          buildInputs = [ old-pkgs.php73 ];
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>      );
</span></span></code></pre></div></div><div class=single-pagination><hr><div class=flex><div class=single-pagination-prev><div class=single-pagination-container-prev><div class=single-pagination-text>‚Üê</div><div class=single-pagination-text><a href=/posts/nix-laravel-01/>Part 0: Integrating Nix for CI, Package Management ft. Laravel</a></div></div></div><div class=single-pagination-next></div></div><hr></div><div class=back-to-top><a href=#top>back to top</a></div></div></main></div><footer><p>Powered by
<a href=https://gohugo.io/>Hugo</a>
and
<a href=https://github.com/tomfran/typo>tomfran/typo</a></p></footer></body><script>function isAuto(){return document.body.classList.contains("auto")}function setTheme(){if(!isAuto())return;document.body.classList.remove("auto");let e="light";window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(e="dark"),document.body.classList.add(e)}function invertBody(){document.body.classList.toggle("dark"),document.body.classList.toggle("light")}isAuto()&&window.matchMedia("(prefers-color-scheme: dark)").addListener(invertBody),setTheme()</script></html>